---
title: "Statistical Analysis of Monthly Background Checks of Gun Purchases"
author: "Gregor Aisch, Josh Keller and Dirk Eddelbuettel"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Monthly Background Checks of Gun Purchases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, setup, include=FALSE}
library(gunsales)
library(seasonal)
library(dplyr)
library(stringr)
library(ggplot2)
library(zoo)
## might just be easier to export these directly from the package...
state_ts <- gunsales:::state_ts
ts_to_dataframe <- gunsales:::ts_to_dataframe
state_data <- gunsales:::state_data
```

## About

This document provides the analysis from the [New York Times](http://www.nytimes.com) 
on-line article ["What Drives Gun Sales: Terrorism, Obama and Calls for Restrictions"](http://www.nytimes.com/interactive/2015/12/10/us/gun-sales-terrorism-obama-restrictions.html?). The [R](http://www.r-project.org) code underlying the analysis is provided
in the [GitHub](http://www.github.com) repository [gun-sales](https://github.com/NYTimes/gun-sales) which contains the R package 


## Analysis I: Base Plots

The first set of charts corresponds to the original release of the underlying code.

```{r, initialDataAndPlot,fig.width=7,echo=FALSE}
## note: the column `multiple_corrected` is a copy of `multiple` in which
## we set the checks in the "multiple" category to 0 for California

alldata <- alldata %>% mutate(guns_sold=(handgun + longgun) * 1.1 + multiple_corrected * 2)

## let's look at the total numbers
total <- alldata %>% state_ts('Totals', 'guns_sold')

## plot total guns sold
op <- par(mar=c(4.5,4.5,2,1))
plot(total / 1e6, main='Total estimated gun sales', ylab='in million', xlab='')

## compute seasonally adjusted gun sales
total.seas <- total %>% seas %>% final

## plot seasonally adjusted gun sales
plot(total.seas / 1e6, main='Total estimated gun sales', ylab='in million', xlab='seasonally adjused')
par(op)
```


```{r, popGrowth,fig.width=7,echo=FALSE}
poptotal <- poptotal %>%
    filter(year >= 2000) %>%
    filter(year < 2015 | month <= 11) %>%
    with(ts(res_pop, start=c(2000,1), frequency = 12))
   
## normalize gun sales by population
total.seas.pop <- total.seas / poptotal * 1000

## plot gun sales normalized to population
plot(total.seas / 280726, main='Estimated gun sales per 1000',
    xlab='red = adjusted for population growth', ylab='')
## and add the not normalized version for comparison
lines(total.seas.pop, col='red')
```


```{r, dataWorkLongGunHandGun,fig.width=7,echo=FALSE}
## create a new data frame that eventually stores all the
## data we need in the final piece
out_data <- ts_to_dataframe(total, 'guns_total') %>% 
    mutate(guns_total=round(guns_total, 3))

out_data <- out_data %>% left_join(
                             ts_to_dataframe( total.seas.pop ) %>%
                             mutate(guns_total_per_1000=round(value,3)) %>%
                             select(year, month, guns_total_per_1000)
                         )

## join in seasonal adjusted numbers
temp <- ts_to_dataframe( total.seas ) %>%
    mutate(guns_total_seas=round(value,3)) %>%
    select(year, month, guns_total_seas)

out_data <- out_data %>%
    left_join(temp, c('year', 'month')) %>%
    filter(year >= 2000)

## join in population adjusted numbers
temp <- ts_to_dataframe( total.seas.pop ) %>%
    mutate(guns_total_per_1000=round(value,3)) %>%
    select(year, month, guns_total_per_1000)

out_data <- out_data %>%
    left_join(temp, c('year', 'month'))

## create a temporary data frame for computing the
## handgun_share and longgun_share columns

tmp.handguns <- alldata %>% state_ts('Totals', 'handgun') %>%
    seas %>% final %>% ts_to_dataframe('handgun')
tmp.longguns <- alldata %>% state_ts('Totals', 'longgun') %>%
    seas %>% final %>% ts_to_dataframe('longgun')
tmp.other <- alldata %>% state_ts('Totals', 'other') %>%
    seas %>% final %>% ts_to_dataframe('other')
tmp.multiple <- alldata %>% state_ts('Totals', 'multiple_corrected') %>%
    seas %>% final %>% ts_to_dataframe('multiple')

## merge above dataframes into one
temp <- tmp.handguns %>%
    left_join(tmp.longguns, c('year', 'month')) %>%
    left_join(tmp.other, c('year', 'month')) %>%
    left_join(tmp.multiple, c('year', 'month'))

## convert NAs to 0 in column other
temp$other[is.na(temp$other)] <- 0

## compute the handgun/longgun share
temp <- temp %>%
    mutate(handgun_share=round(handgun / (handgun + longgun + other + multiple * 0.5), 4)) %>%
    mutate(longgun_share=round(longgun / (handgun + longgun + other + multiple * 0.5), 4)) %>% 
    select(year, month, handgun_share, longgun_share)

## join into master data frame
out_data <- out_data %>%
    left_join(temp, c('year', 'month')) %>%
    filter(year >= 2000)

## plot handgun/longgun 
temp$time <- temp$year + (temp$month-1) / 12

temp %>% with(plot(time, longgun_share, type='l', col='blue',
                   ylim=c(0.2,0.8), main='Long guns vs handguns',
                   ylab='', xlab='red = handguns, blue = long guns'))
temp %>% with(lines(time, handgun_share, col='red'))
```


```{r, byState, fig.width=7, fig.height=7,echo=FALSE}
## plot percent of national for selected states 
show_states <- c('New Jersey', 'Maryland', 'Georgia',
                 'Louisiana', 'Mississippi', 'Missouri')

op <- par(mfrow=c(3,2), mar=c(2,3,3,1))
for (s in show_states) {
    s.ts <- state_data(alldata, s, total, total.seas)

    ## plot staate data
    plot(s.ts, main=paste(s), xlab='pct of national gun sales')

    ## merge with out_data
    temp <- ts_to_dataframe(s.ts) %>% mutate(value=round(value,3))
    colnames(temp) <- c('year', 'month', str_replace_all(str_to_lower(s), ' ', '_'))
    out_data <- out_data %>% left_join(temp, c('year', 'month'))
}
par(op)
#head(out_data)
```


```{r, DC, fig.width=7,echo=FALSE}
## compute handgun sales for DC: handung * 1.1 + multiple

dc.handgun_checks <- state_ts(alldata, 'District of Columbia', 'handgun', outer_zeros_to_na=F)
dc.multiple <- state_ts(alldata, 'District of Columbia', 'multiple', outer_zeros_to_na=F)
dc.handgun <- (dc.handgun_checks * 1.1 + dc.multiple + 1) %>% seas %>% final - 1
total.handgun <- (state_ts(alldata, 'Totals', 'handgun') * 1.1 +
                  state_ts(alldata, 'Totals', 'multiple')) %>% seas %>% final
dc.handgun.pct <- dc.handgun / total.handgun * 100000

## plot DC chart
plot(dc.handgun.pct, main='Washington D.C.', xlab='sales per 100,000 national handguns')

## merge with out_data
temp <- ts_to_dataframe(round(dc.handgun.pct, 1), 'dc_handguns_per_100k_national_sales')
out_data <- out_data %>% left_join(temp, c('year', 'month'))

## estimate how much more guns are sold missouri after law change
missouri <- state_data(alldata, 'Missouri', normalize = F, adj_seasonal = F)
missouri.avg_pre_2007 <- mean(missouri[73:84])
missouri.avg_post_2008 <- mean(missouri[97:108])
#cat('Increase in monthly gun sales in Missouri =', missouri.avg_post_2008 - missouri.avg_pre_2007, "\n")   
```

## Analysis II: ggplot2 Plots

The second set of charts corresponds redoes the same analysis but uses [ggplot2](http://cloud.r-project.org/package=ggplot2) for its charts.


```{r, initialDataAndPlot2,fig.width=7,echo=FALSE}
data("alldata", envir=environment())              # load package datasets
data("poptotal", envir=environment())
    
alldata <- alldata %>% mutate(guns_sold=(handgun + longgun) * 1.1 + multiple_corrected * 2)
total <- alldata %>% state_ts('Totals', 'guns_sold')

ztotal <- zoo(total)
zdf <- data.frame(Date=as.Date(as.yearmon(index(ztotal))), 
                  Sales=coredata(ztotal/1e6))
print(ggplot(data=zdf, aes(x=Date, y=Sales)) + geom_line() + scale_x_date() + 
      ggtitle("Total estimated gun sales") + ylab("in million") + xlab(""))
## compute seasonally adjusted gun sales
total.seas <- total %>% seas %>% final
##total.seas <- final(seas(total))

## plot seasonally adjusted gun sales
ztotseas <- zoo(total.seas)
ztsdf <- data.frame(Date=as.Date(as.yearmon(index(ztotseas))), 
                    Sales=coredata(ztotseas/1e6))

#plot(total.seas / 1e6, main='Total estimated gun sales', ylab='in million', xlab='seasonally adjused')
print(ggplot(data=ztsdf, aes(x=Date, y=Sales)) + geom_line() + scale_x_date() +
      ggtitle("Total estimated gun sales") + ylab("in million") + xlab("seasonally adjusted"))
```

```{r, popGrowth2,fig.width=7,echo=FALSE}
poptotal <- poptotal %>%
    filter(year >= 2000) %>%
    filter(year < 2015 | month <= 11) %>%
    with(ts(res_pop, start=c(2000,1), frequency = 12))

## normalize gun sales by population
total.seas.pop <- total.seas / poptotal * 1000

## plot gun sales normalized to population
#plot(total.seas / 280726, main='Estimated gun sales per 1000',
#     xlab='red = adjusted for population growth', ylab='')
## and add the not normalized version for comparison
#lines(total.seas.pop, col='red')

ztotseaspop <- zoo(total.seas.pop)
ztspdf <- data.frame(Date=as.Date(as.yearmon(index(ztotseaspop))),
                     Sales=coredata(ztotseas/280726),
                     SalesAdjusted=coredata(ztotseaspop))
dt <- data.table::data.table(ztspdf)
ndt <- data.table::melt(dt, measure.vars=c("Sales", "SalesAdjusted"), id.var="Date")
print(ggplot(data=ndt, aes(x=Date, y=value)) + geom_line(aes(colour=variable)) + scale_x_date() + 
    ggtitle("Estimated gun sales per 1000") + xlab("red = adjusted for population growth") +
    ylab("") + theme(legend.position="bottom") + theme(legend.title=element_blank()) +
    scale_colour_manual(values=c("black", "red")))
```


```{r, dataWorkLongGunHandGun2,fig.width=7,echo=FALSE}
## create a new data frame that eventually stores all the
## data we need in the final piece
out_data <- ts_to_dataframe(total, 'guns_total') %>% 
    mutate(guns_total=round(guns_total, 3))

out_data <- out_data %>% left_join(
                             ts_to_dataframe( total.seas.pop ) %>%
                             mutate(guns_total_per_1000=round(value,3)) %>%
                             select(year, month, guns_total_per_1000)
                         )

## join in seasonal adjusted numbers
temp <- ts_to_dataframe( total.seas ) %>%
    mutate(guns_total_seas=round(value,3)) %>%
    select(year, month, guns_total_seas)

out_data <- out_data %>%
    left_join(temp, c('year', 'month')) %>%
    filter(year >= 2000)

## join in population adjusted numbers
temp <- ts_to_dataframe( total.seas.pop ) %>%
    mutate(guns_total_per_1000=round(value,3)) %>%
    select(year, month, guns_total_per_1000)

out_data <- out_data %>%
    left_join(temp, c('year', 'month'))

## create a temporary data frame for computing the
## handgun_share and longgun_share columns

tmp.handguns <- alldata %>% state_ts('Totals', 'handgun') %>%
    seas %>% final %>% ts_to_dataframe('handgun')
tmp.longguns <- alldata %>% state_ts('Totals', 'longgun') %>%
    seas %>% final %>% ts_to_dataframe('longgun')
tmp.other <- alldata %>% state_ts('Totals', 'other') %>%
    seas %>% final %>% ts_to_dataframe('other')
tmp.multiple <- alldata %>% state_ts('Totals', 'multiple_corrected') %>%
    seas %>% final %>% ts_to_dataframe('multiple')

## merge above dataframes into one
temp <- tmp.handguns %>%
    left_join(tmp.longguns, c('year', 'month')) %>%
    left_join(tmp.other, c('year', 'month')) %>%
    left_join(tmp.multiple, c('year', 'month'))

## convert NAs to 0 in column other
temp$other[is.na(temp$other)] <- 0

## compute the handgun/longgun share
temp <- temp %>%
    mutate(handgun_share=round(handgun / (handgun + longgun + other + multiple * 0.5), 4)) %>%
    mutate(longgun_share=round(longgun / (handgun + longgun + other + multiple * 0.5), 4)) %>% 
    select(year, month, handgun_share, longgun_share)

## join into master data frame
out_data <- out_data %>%
    left_join(temp, c('year', 'month')) %>%
    filter(year >= 2000)

## plot handgun/longgun 
temp$time <- temp$year + (temp$month-1) / 12

#temp %>% with(plot(time, longgun_share, type='l', col='blue',
#                   ylim=c(0.2,0.8), main='Long guns vs handguns',
#                   ylab='', xlab='red = handguns, blue = long guns'))
#temp %>% with(lines(time, handgun_share, col='red'))

tt <- data.table::data.table(temp)
ntt <- data.table::melt(tt, measure.vars=c("handgun_share", "longgun_share"), id.var="time")
ntt[,time := as.Date(as.yearmon(time))]
print(ggplot(data=ntt, aes(x=time, y=value)) + geom_line(aes(colour=variable)) + scale_x_date() +
      ggtitle("Long guns vs handguns") +
        xlab("red = handguns, blue = long guns") + ylab("") +
        theme(legend.position="none") + #theme(legend.title=element_blank()) +
        scale_colour_manual(values=c("blue", "red")))
```

```{r, byState2, fig.width=7, fig.height=7,echo=FALSE}
## plot percent of national for selected states 
show_states <- c('New Jersey', 'Maryland', 'Georgia',
                 'Louisiana', 'Mississippi', 'Missouri')

## do it again, but less crazy
rl <- lapply(show_states, function(s) {
    s.ts <- as.zoo(state_data(alldata, s, total, total.seas))
    zts <- zoo(coredata(s.ts), order.by=as.Date(as.yearmon(index(s.ts))))
})
nd <- do.call(merge, rl)
colnames(nd) <- show_states
ndf <- data.table::data.table(Date=index(nd), coredata(nd))
pdf <- data.table::melt(ndf, id.vars="Date")

print(ggplot(data=pdf, aes(x=Date, y=value)) + geom_line() + 
    facet_wrap( ~ variable) + 
    xlab("Percentage of National Sales") + ylab(""))
```

```{r, DC2, fig.width=7,echo=FALSE}
dc.handgun_checks <- state_ts(alldata, 'District of Columbia', 'handgun', outer_zeros_to_na=F)
dc.multiple <- state_ts(alldata, 'District of Columbia', 'multiple', outer_zeros_to_na=F)
dc.handgun <- (dc.handgun_checks * 1.1 + dc.multiple + 1) %>% seas %>% final - 1
total.handgun <- (state_ts(alldata, 'Totals', 'handgun') * 1.1 +
                  state_ts(alldata, 'Totals', 'multiple')) %>% seas %>% final
dc.handgun.pct <- dc.handgun / total.handgun * 100000

## plot DC chart
#plot(dc.handgun.pct, main='Washington D.C.', xlab='sales per 100,000 national handguns')

dcz <- as.zoo(dc.handgun.pct)
dcdf <- data.frame(Date=as.Date(as.yearmon(index(dcz))), Value=coredata(dcz))
print(ggplot(data=dcdf, aes(x=Date, y=Value)) + geom_line() +
             ggtitle("Washington D.C.") + xlab("Sales per 100,000 national handguns"))
```
